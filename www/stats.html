<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主页访问统计</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .stats-summary { display: flex; justify-content: space-around; margin: 20px 0; }
        .stat-box { text-align: center; padding: 15px; background: #007bff; color: white; border-radius: 8px; min-width: 120px; }
        .stat-number { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        #chartContainer { height: 400px; margin: 30px 0; }
        .update-time { text-align: center; color: #666; font-size: 12px; margin-top: 20px; }
        .loading { text-align: center; color: #666; }
        .error { text-align: center; color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 主页访问统计 <span id="autoRefresh">🔄</span></h1>
        
        <div class="stats-summary">
            <div class="stat-box">
                <div class="stat-number" id="totalVisits">--</div>
                <div class="stat-label">24小时总访问</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="peakHour">--:--</div>
                <div class="stat-label">访问高峰</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="avgHourly">--</div>
                <div class="stat-label">平均每小时</div>
            </div>
        </div>

        <div id="loading" class="loading">正在加载数据...</div>
        <div id="error" class="error" style="display:none;">数据加载失败，正在重试...</div>

        <div id="chartContainer" style="display:none;">
            <canvas id="visitChart"></canvas>
        </div>

        <div class="update-time">
            最后更新: <span id="lastUpdate">--</span> | 
            自动刷新: <span id="nextUpdate">--</span>秒后
        </div>
    </div>

    <script>
        let chart;
        let refreshTimer;
        let countdownTimer;
        let nextRefresh = 60;

        // 获取最新统计数据
        async function fetchLatestStats() {
            try {
                // 获取日志目录列表
                const response = await fetch('/log/', {
                    method: 'GET',
                    headers: {'Accept': 'text/html'}
                });
                
                if (!response.ok) throw new Error('无法访问日志目录');
                
                const html = await response.text();
                
                // 解析HTML找到最新的stats文件
                const statsFiles = html.match(/stats_\d{8}_\d{4}\.json/g) || [];
                if (statsFiles.length === 0) throw new Error('未找到统计文件');
                
                // 获取最新文件
                const latestFile = statsFiles.sort().reverse()[0];
                
                // 加载统计数据
                const statsResponse = await fetch(`/log/${latestFile}`);
                if (!statsResponse.ok) throw new Error('无法加载统计数据');
                
                const data = await statsResponse.json();
                return data;
                
            } catch (error) {
                console.error('获取数据失败:', error);
                throw error;
            }
        }

        // 更新页面数据
        function updatePage(data) {
            // 更新摘要数据
            document.getElementById('totalVisits').textContent = data.summary.total_visits;
            document.getElementById('peakHour').textContent = data.summary.peak_hour;
            document.getElementById('avgHourly').textContent = data.summary.avg_hourly;
            document.getElementById('lastUpdate').textContent = data.summary.last_update;

            // 准备图表数据
            const hourlyData = data.hourly_data.map(item => item.count);
            const hours = data.hourly_data.map(item => String(item.hour).padStart(2, '0') + ':00');

            // 更新或创建图表
            if (chart) {
                chart.data.datasets[0].data = hourlyData;
                chart.update();
            } else {
                const ctx = document.getElementById('visitChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: hours,
                        datasets: [{
                            label: '访问次数',
                            data: hourlyData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#007bff',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)' } },
                            x: { grid: { color: 'rgba(0,0,0,0.1)' } }
                        },
                        interaction: { intersect: false, mode: 'index' }
                    }
                });
            }

            // 显示图表，隐藏加载状态
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'block';
        }

        // 加载数据
        async function loadData() {
            try {
                const data = await fetchLatestStats();
                updatePage(data);
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                console.error('加载失败:', error);
            }
        }

        // 倒计时显示
        function updateCountdown() {
            document.getElementById('nextUpdate').textContent = nextRefresh;
            nextRefresh--;
            
            if (nextRefresh < 0) {
                nextRefresh = 60;
                loadData();
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // 每60秒自动刷新数据
            refreshTimer = setInterval(loadData, 60000);
            
            // 每秒更新倒计时
            countdownTimer = setInterval(updateCountdown, 1000);
        });

        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            if (refreshTimer) clearInterval(refreshTimer);
            if (countdownTimer) clearInterval(countdownTimer);
        });
    </script>
</body>
</html>