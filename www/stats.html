<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é¡µè®¿é—®ç»Ÿè®¡</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .stats-summary { display: flex; justify-content: space-around; margin: 20px 0; }
        .stat-box { text-align: center; padding: 15px; background: #007bff; color: white; border-radius: 8px; min-width: 120px; }
        .stat-number { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        #chartContainer { height: 400px; margin: 30px 0; }
        .update-time { text-align: center; color: #666; font-size: 12px; margin-top: 20px; }
        .loading { text-align: center; color: #666; }
        .error { text-align: center; color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ä¸»é¡µè®¿é—®ç»Ÿè®¡ <span id="autoRefresh">ğŸ”„</span></h1>
        
        <div class="stats-summary">
            <div class="stat-box">
                <div class="stat-number" id="totalVisits">--</div>
                <div class="stat-label">24å°æ—¶æ€»è®¿é—®</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="peakHour">--:--</div>
                <div class="stat-label">è®¿é—®é«˜å³°</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="avgHourly">--</div>
                <div class="stat-label">å¹³å‡æ¯å°æ—¶</div>
            </div>
        </div>

        <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        <div id="error" class="error" style="display:none;">æ•°æ®åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...</div>

        <div id="chartContainer" style="display:none;">
            <canvas id="visitChart"></canvas>
        </div>

        <div class="update-time">
            æœ€åæ›´æ–°: <span id="lastUpdate">--</span> | 
            è‡ªåŠ¨åˆ·æ–°: <span id="nextUpdate">--</span>ç§’å
        </div>
    </div>

    <script>
        let chart;
        let refreshTimer;
        let countdownTimer;
        let nextRefresh = 60;

        // è·å–æœ€æ–°ç»Ÿè®¡æ•°æ®
        async function fetchLatestStats() {
            try {
                // è·å–æ—¥å¿—ç›®å½•åˆ—è¡¨
                const response = await fetch('/log/', {
                    method: 'GET',
                    headers: {'Accept': 'text/html'}
                });
                
                if (!response.ok) throw new Error('æ— æ³•è®¿é—®æ—¥å¿—ç›®å½•');
                
                const html = await response.text();
                
                // è§£æHTMLæ‰¾åˆ°æœ€æ–°çš„statsæ–‡ä»¶
                const statsFiles = html.match(/stats_\d{8}_\d{4}\.json/g) || [];
                if (statsFiles.length === 0) throw new Error('æœªæ‰¾åˆ°ç»Ÿè®¡æ–‡ä»¶');
                
                // è·å–æœ€æ–°æ–‡ä»¶
                const latestFile = statsFiles.sort().reverse()[0];
                
                // åŠ è½½ç»Ÿè®¡æ•°æ®
                const statsResponse = await fetch(`/log/${latestFile}`);
                if (!statsResponse.ok) throw new Error('æ— æ³•åŠ è½½ç»Ÿè®¡æ•°æ®');
                
                const data = await statsResponse.json();
                return data;
                
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // æ›´æ–°é¡µé¢æ•°æ®
        function updatePage(data) {
            // æ›´æ–°æ‘˜è¦æ•°æ®
            document.getElementById('totalVisits').textContent = data.summary.total_visits;
            document.getElementById('peakHour').textContent = data.summary.peak_hour;
            document.getElementById('avgHourly').textContent = data.summary.avg_hourly;
            document.getElementById('lastUpdate').textContent = data.summary.last_update;

            // å‡†å¤‡å›¾è¡¨æ•°æ®
            const hourlyData = data.hourly_data.map(item => item.count);
            const hours = data.hourly_data.map(item => String(item.hour).padStart(2, '0') + ':00');

            // æ›´æ–°æˆ–åˆ›å»ºå›¾è¡¨
            if (chart) {
                chart.data.datasets[0].data = hourlyData;
                chart.update();
            } else {
                const ctx = document.getElementById('visitChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: hours,
                        datasets: [{
                            label: 'è®¿é—®æ¬¡æ•°',
                            data: hourlyData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#007bff',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)' } },
                            x: { grid: { color: 'rgba(0,0,0,0.1)' } }
                        },
                        interaction: { intersect: false, mode: 'index' }
                    }
                });
            }

            // æ˜¾ç¤ºå›¾è¡¨ï¼Œéšè—åŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'block';
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const data = await fetchLatestStats();
                updatePage(data);
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                console.error('åŠ è½½å¤±è´¥:', error);
            }
        }

        // å€’è®¡æ—¶æ˜¾ç¤º
        function updateCountdown() {
            document.getElementById('nextUpdate').textContent = nextRefresh;
            nextRefresh--;
            
            if (nextRefresh < 0) {
                nextRefresh = 60;
                loadData();
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°æ•°æ®
            refreshTimer = setInterval(loadData, 60000);
            
            // æ¯ç§’æ›´æ–°å€’è®¡æ—¶
            countdownTimer = setInterval(updateCountdown, 1000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            if (refreshTimer) clearInterval(refreshTimer);
            if (countdownTimer) clearInterval(countdownTimer);
        });
    </script>
</body>
</html>